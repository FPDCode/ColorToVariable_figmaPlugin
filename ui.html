<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: #333;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #e0e0e0;
    }
    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-weight: 500;
      cursor: pointer;
      background: #f5f5f5;
      border: none;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover {
      background: #eee;
    }
    .tab.active {
      background: white;
      border-bottom-color: #18a0fb;
      color: #18a0fb;
    }
    .tab-content {
      padding: 16px;
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    h3 {
      margin: 0 0 12px 0;
      font-size: 13px;
      font-weight: 600;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 12px;
      background: white;
    }
    button.primary {
      width: 100%;
      padding: 10px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.primary:hover {
      background: #0d8ae0;
    }
    button.primary:active {
      background: #0b7ac9;
    }
    button.primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .message {
      margin-top: 12px;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      display: none;
    }
    .message.success {
      background: #e6f7e6;
      color: #2d7a2d;
      border: 1px solid #a5d6a5;
    }
    .message.error {
      background: #ffe6e6;
      color: #c92a2a;
      border: 1px solid #faa;
    }
    .hint {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="tabs">
    <button class="tab active" data-tab="create">Create Variables</button>
    <button class="tab" data-tab="generate">Generate Layers</button>
    <button class="tab" data-tab="extract">Extract Primitives</button>
  </div>

  <!-- Tab 1: Create Variables -->
  <div id="create-tab" class="tab-content active">
    <h3>Layers → Variables</h3>
    <div class="form-group">
      <label for="collection">Collection</label>
      <select id="collection">
        <option value="">Create new collection</option>
      </select>
      <div class="hint">Select a collection or create a new one</div>
    </div>
    <button id="create" class="primary">Create Variables</button>
    <div id="create-message" class="message"></div>
  </div>

  <!-- Tab 2: Generate Layers -->
  <div id="generate-tab" class="tab-content">
    <h3>Variables → Layers</h3>
    <div class="form-group">
      <label for="gen-collection">Collection</label>
      <select id="gen-collection">
        <option value="" disabled selected>Select a collection</option>
      </select>
      <div class="hint">Creates 200×200 rectangles for each color variable</div>
    </div>
    <button id="generate" class="primary" disabled>Generate Layers</button>
    <div id="generate-message" class="message"></div>
  </div>

  <!-- Tab 3: Extract Primitives -->
  <div id="extract-tab" class="tab-content">
    <h3>Layers → Primitives</h3>
    <div class="form-group">
      <label for="extract-collection">Collection</label>
      <select id="extract-collection">
        <option value="">Create new collection</option>
      </select>
      <div class="hint">Extracts computed colors (fill + opacity over parent background)</div>
    </div>
    <button id="extract" class="primary">Extract Primitives</button>
    <div id="extract-message" class="message"></div>
  </div>

  <script>
    // Tab switching
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
      tab.onclick = () => {
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      };
    });

    // Elements
    const collectionSelect = document.getElementById('collection');
    const createButton = document.getElementById('create');
    const createMessageDiv = document.getElementById('create-message');
    
    const genCollectionSelect = document.getElementById('gen-collection');
    const generateButton = document.getElementById('generate');
    const generateMessageDiv = document.getElementById('generate-message');

    const extractCollectionSelect = document.getElementById('extract-collection');
    const extractButton = document.getElementById('extract');
    const extractMessageDiv = document.getElementById('extract-message');

    function showMessage(element, text, type) {
      element.textContent = text;
      element.className = `message ${type}`;
      element.style.display = 'block';
      
      setTimeout(() => {
        element.style.display = 'none';
      }, 3000);
    }

    // Enable/disable generate button based on selection
    genCollectionSelect.onchange = () => {
      generateButton.disabled = !genCollectionSelect.value;
    };

    // Create Variables button
    createButton.onclick = () => {
      const collectionId = collectionSelect.value || null;
      parent.postMessage({ 
        pluginMessage: { 
          type: 'create-variables', 
          collectionId 
        } 
      }, '*');
    };

    // Generate Layers button
    generateButton.onclick = () => {
      const collectionId = genCollectionSelect.value;
      if (!collectionId) return;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'generate-layers', 
          collectionId 
        } 
      }, '*');
    };

    // Extract Primitives button
    extractButton.onclick = () => {
      const collectionId = extractCollectionSelect.value || null;
      parent.postMessage({ 
        pluginMessage: { 
          type: 'extract-primitives', 
          collectionId 
        } 
      }, '*');
    };

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'collections') {
        // Save current selections
        const currentValue = collectionSelect.value;
        const currentGenValue = genCollectionSelect.value;
        const currentExtractValue = extractCollectionSelect.value;
        
        // Update create tab dropdown
        collectionSelect.innerHTML = '<option value="">Create new collection</option>';
        msg.collections.forEach(collection => {
          const option = document.createElement('option');
          option.value = collection.id;
          option.textContent = collection.name;
          collectionSelect.appendChild(option);
        });
        
        // Update generate tab dropdown
        genCollectionSelect.innerHTML = '<option value="" disabled>Select a collection</option>';
        msg.collections.forEach(collection => {
          const option = document.createElement('option');
          option.value = collection.id;
          option.textContent = collection.name;
          genCollectionSelect.appendChild(option);
        });

        // Update extract tab dropdown
        extractCollectionSelect.innerHTML = '<option value="">Create new collection</option>';
        msg.collections.forEach(collection => {
          const option = document.createElement('option');
          option.value = collection.id;
          option.textContent = collection.name;
          extractCollectionSelect.appendChild(option);
        });
        
        // Restore selections
        if (currentValue) collectionSelect.value = currentValue;
        if (currentGenValue) {
          genCollectionSelect.value = currentGenValue;
          generateButton.disabled = false;
        }
        if (currentExtractValue) extractCollectionSelect.value = currentExtractValue;
      }
      
      if (msg.type === 'success') {
        showMessage(createMessageDiv, msg.message, 'success');
      }
      
      if (msg.type === 'generate-success') {
        showMessage(generateMessageDiv, msg.message, 'success');
      }
      
      if (msg.type === 'error') {
        showMessage(createMessageDiv, msg.message, 'error');
      }
      
      if (msg.type === 'generate-error') {
        showMessage(generateMessageDiv, msg.message, 'error');
      }

      if (msg.type === 'extract-success') {
        showMessage(extractMessageDiv, msg.message, 'success');
      }

      if (msg.type === 'extract-error') {
        showMessage(extractMessageDiv, msg.message, 'error');
      }
    };
  </script>
</body>
</html>
