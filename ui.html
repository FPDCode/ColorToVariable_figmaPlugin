<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: #333;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #e0e0e0;
    }
    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-weight: 500;
      cursor: pointer;
      background: #f5f5f5;
      border: none;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover {
      background: #eee;
    }
    .tab.active {
      background: white;
      border-bottom-color: #18a0fb;
      color: #18a0fb;
    }
    .tab-content {
      padding: 16px;
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    h3 {
      margin: 0 0 12px 0;
      font-size: 13px;
      font-weight: 600;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 12px;
      background: white;
    }
    button.primary {
      width: 100%;
      padding: 10px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.primary:hover {
      background: #0d8ae0;
    }
    button.primary:active {
      background: #0b7ac9;
    }
    button.primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .message {
      margin-top: 12px;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      display: none;
    }
    .message.success {
      background: #e6f7e6;
      color: #2d7a2d;
      border: 1px solid #a5d6a5;
    }
    .message.error {
      background: #ffe6e6;
      color: #c92a2a;
      border: 1px solid #faa;
    }
    .hint {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }
    .mode-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .mode-btn {
      flex: 1;
      padding: 8px 4px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: #666;
      transition: all 0.2s;
    }
    .mode-btn:hover {
      border-color: #18a0fb;
      background: #f0f9ff;
    }
    .mode-btn.active {
      border-color: #18a0fb;
      background: #e6f4ff;
      color: #18a0fb;
    }
    .mode-icon {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mode-icon.light {
      background: linear-gradient(135deg, #fff 50%, #f0f0f0 50%);
      border: 1px solid #ddd;
    }
    .mode-icon.dark {
      background: linear-gradient(135deg, #333 50%, #1a1a1a 50%);
      border: 1px solid #555;
    }
    .mode-icon.ic-light {
      background: #fff;
      border: 2px solid #000;
    }
    .mode-icon.ic-dark {
      background: #000;
      border: 2px solid #fff;
    }
    .hex-input-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .color-preview {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      flex-shrink: 0;
    }
    .hex-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 12px;
      font-family: monospace;
    }
    .text-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 12px;
    }
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      margin-top: 12px;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 6px;
    }
    .preview-swatch {
      aspect-ratio: 1;
      border-radius: 4px;
      border: 1px solid #ddd;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 2px;
    }
    .preview-swatch span {
      font-size: 8px;
      color: #666;
      background: rgba(255,255,255,0.8);
      padding: 1px 3px;
      border-radius: 2px;
    }
    .switch-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .switch-label {
      font-weight: 500;
    }
    .switch {
      position: relative;
      width: 36px;
      height: 20px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.2s;
      border-radius: 20px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.2s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #18a0fb;
    }
    input:checked + .slider:before {
      transform: translateX(16px);
    }
  </style>
</head>
<body>
  <div class="tabs">
    <button class="tab active" data-tab="create">Create</button>
    <button class="tab" data-tab="generate">Generate</button>
    <button class="tab" data-tab="interpolate">Interpolate</button>
    <button class="tab" data-tab="modemaker">Modes</button>
  </div>

  <!-- Tab 1: Create Variables -->
  <div id="create-tab" class="tab-content active">
    <h3>Layers → Variables</h3>
    <div class="form-group">
      <label for="collection">Collection</label>
      <select id="collection">
        <option value="">Create new collection</option>
      </select>
      <div class="hint">Select a collection or create a new one</div>
    </div>
    <button id="create" class="primary">Create Variables</button>
    <div id="create-message" class="message"></div>
  </div>

  <!-- Tab 2: Generate Layers -->
  <div id="generate-tab" class="tab-content">
    <h3>Variables → Layers</h3>
    <div class="form-group">
      <label for="gen-collection">Collection</label>
      <select id="gen-collection">
        <option value="" disabled selected>Select a collection</option>
      </select>
      <div class="hint">Creates 200×200 rectangles for each color variable</div>
    </div>
    <div class="switch-row">
      <span class="switch-label">Bind variables to fills</span>
      <label class="switch">
        <input type="checkbox" id="bind-variables">
        <span class="slider"></span>
      </label>
    </div>
    <button id="generate" class="primary" disabled>Generate Layers</button>
    <div id="generate-message" class="message"></div>
  </div>

  <!-- Tab 3: Interpolate Colors -->
  <div id="interpolate-tab" class="tab-content">
    <h3>Keys → Color Scale</h3>
    <div class="form-group">
      <label for="interpolate-collection">Collection</label>
      <select id="interpolate-collection">
        <option value="">Create new collection</option>
      </select>
      <div class="hint">Select key colors (e.g., 300, 500 Light, 500 Dark, 700) to generate full 000-1000 scale</div>
    </div>
    <button id="interpolate" class="primary">Interpolate Colors</button>
    <div id="interpolate-message" class="message"></div>
  </div>

  <!-- Tab 5: Mode Maker -->
  <div id="modemaker-tab" class="tab-content">
    <h3>Hex → Light/Dark Modes</h3>
    
    <div class="form-group">
      <label for="mode-collection">Collection</label>
      <select id="mode-collection">
        <option value="">Create new collection</option>
      </select>
    </div>

    <div class="form-group">
      <label>Input Mode</label>
      <div class="mode-selector">
        <button class="mode-btn active" data-mode="Light">
          <div class="mode-icon light"></div>
          <span>Light</span>
        </button>
        <button class="mode-btn" data-mode="Dark">
          <div class="mode-icon dark"></div>
          <span>Dark</span>
        </button>
        <button class="mode-btn" data-mode="IC - Light">
          <div class="mode-icon ic-light"></div>
          <span>IC - Light</span>
        </button>
        <button class="mode-btn" data-mode="IC - Dark">
          <div class="mode-icon ic-dark"></div>
          <span>IC - Dark</span>
        </button>
      </div>
    </div>

    <div class="form-group">
      <label for="hex-input">Hex Color</label>
      <div class="hex-input-row">
        <div id="color-preview" class="color-preview"></div>
        <input type="text" id="hex-input" class="hex-input" placeholder="FF383C" maxlength="7">
      </div>
    </div>

    <div class="form-group">
      <label for="var-name">Variable Name</label>
      <input type="text" id="var-name" class="text-input" placeholder="Colors/Red">
      <div class="hint">Use / for groups (e.g., Backgrounds/Primary)</div>
    </div>

    <div class="preview-grid" id="preview-grid">
      <div class="preview-swatch" id="preview-light" style="background:#ccc"><span>Light</span></div>
      <div class="preview-swatch" id="preview-dark" style="background:#ccc"><span>Dark</span></div>
      <div class="preview-swatch" id="preview-ic-light" style="background:#ccc"><span>IC - L</span></div>
      <div class="preview-swatch" id="preview-ic-dark" style="background:#ccc"><span>IC - D</span></div>
    </div>

    <button id="generate-modes" class="primary" style="margin-top:12px">Generate Mode Colors</button>
    <div id="modemaker-message" class="message"></div>
  </div>

  <script>
    // Tab switching
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
      tab.onclick = () => {
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      };
    });

    // Elements
    const collectionSelect = document.getElementById('collection');
    const createButton = document.getElementById('create');
    const createMessageDiv = document.getElementById('create-message');
    
    const genCollectionSelect = document.getElementById('gen-collection');
    const generateButton = document.getElementById('generate');
    const generateMessageDiv = document.getElementById('generate-message');

    const interpolateCollectionSelect = document.getElementById('interpolate-collection');
    const interpolateButton = document.getElementById('interpolate');
    const interpolateMessageDiv = document.getElementById('interpolate-message');

    // Mode Maker elements
    const modeCollectionSelect = document.getElementById('mode-collection');
    const hexInput = document.getElementById('hex-input');
    const varNameInput = document.getElementById('var-name');
    const colorPreview = document.getElementById('color-preview');
    const generateModesButton = document.getElementById('generate-modes');
    const modemakerMessageDiv = document.getElementById('modemaker-message');
    const modeBtns = document.querySelectorAll('.mode-btn');
    let selectedMode = 'Light';

    // Mode button selection
    modeBtns.forEach(btn => {
      btn.onclick = () => {
        modeBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedMode = btn.dataset.mode;
        updateColorPreview();
      };
    });

    // Hex input handling
    hexInput.oninput = () => {
      let val = hexInput.value.replace(/[^0-9A-Fa-f]/g, '').toUpperCase();
      if (val.length > 6) val = val.substring(0, 6);
      hexInput.value = val;
      updateColorPreview();
    };

    function hexToRgb(hex) {
      if (hex.length !== 6) return null;
      const r = parseInt(hex.substring(0, 2), 16) / 255;
      const g = parseInt(hex.substring(2, 4), 16) / 255;
      const b = parseInt(hex.substring(4, 6), 16) / 255;
      return { r, g, b };
    }

    function rgbToHex(r, g, b) {
      const toHex = (c) => Math.round(Math.max(0, Math.min(1, c)) * 255).toString(16).padStart(2, '0').toUpperCase();
      return toHex(r) + toHex(g) + toHex(b);
    }

    function rgbToHsl(r, g, b) {
      const max = Math.max(r, g, b), min = Math.min(r, g, b);
      let h = 0, s = 0, l = (max + min) / 2;
      if (max !== min) {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
          case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
          case g: h = ((b - r) / d + 2) / 6; break;
          case b: h = ((r - g) / d + 4) / 6; break;
        }
      }
      return { h, s, l };
    }

    function hslToRgb(h, s, l) {
      let r, g, b;
      if (s === 0) {
        r = g = b = l;
      } else {
        const hue2rgb = (p, q, t) => {
          if (t < 0) t += 1;
          if (t > 1) t -= 1;
          if (t < 1/6) return p + (q - p) * 6 * t;
          if (t < 1/2) return q;
          if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
          return p;
        };
        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        r = hue2rgb(p, q, h + 1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1/3);
      }
      return { r, g, b };
    }

    function isGrayscale(r, g, b) {
      const hsl = rgbToHsl(r, g, b);
      return hsl.s < 0.05;
    }

    function adjustHsl(r, g, b, lDelta, sDelta) {
      const hsl = rgbToHsl(r, g, b);
      const newL = Math.max(0, Math.min(1, hsl.l + lDelta));
      const newS = Math.max(0, Math.min(1, hsl.s + sDelta));
      return hslToRgb(hsl.h, newS, newL);
    }

    function generateModeColors(inputHex, inputMode) {
      const rgb = hexToRgb(inputHex);
      if (!rgb) return null;

      const grayscale = isGrayscale(rgb.r, rgb.g, rgb.b);
      let lightRgb;

      // First, convert input to Light base
      if (inputMode === 'Light') {
        lightRgb = rgb;
      } else if (grayscale) {
        // Grayscale reverse transformations
        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        if (inputMode === 'Dark') {
          lightRgb = hslToRgb(hsl.h, hsl.s, 1 - hsl.l); // Invert
        } else if (inputMode === 'IC - Light') {
          lightRgb = hslToRgb(hsl.h, hsl.s, hsl.l + 0.05); // Reverse darken
        } else { // IC - Dark
          lightRgb = hslToRgb(hsl.h, hsl.s, 1 - (hsl.l - 0.05)); // Reverse lighten + invert
        }
      } else {
        // Chromatic reverse transformations
        if (inputMode === 'Dark') {
          lightRgb = adjustHsl(rgb.r, rgb.g, rgb.b, -0.03, 0);
        } else if (inputMode === 'IC - Light') {
          lightRgb = adjustHsl(rgb.r, rgb.g, rgb.b, 0.12, -0.08);
        } else { // IC - Dark
          lightRgb = adjustHsl(rgb.r, rgb.g, rgb.b, -0.15, 0);
        }
      }

      // Generate all 4 modes from Light base
      let results = {};
      if (grayscale) {
        const lightHsl = rgbToHsl(lightRgb.r, lightRgb.g, lightRgb.b);
        results.Light = lightRgb;
        results.Dark = hslToRgb(lightHsl.h, lightHsl.s, 1 - lightHsl.l);
        results['IC - Light'] = hslToRgb(lightHsl.h, lightHsl.s, Math.max(0, lightHsl.l - 0.05));
        const darkL = 1 - lightHsl.l;
        results['IC - Dark'] = hslToRgb(lightHsl.h, lightHsl.s, Math.min(1, darkL + 0.05));
      } else {
        results.Light = lightRgb;
        results.Dark = adjustHsl(lightRgb.r, lightRgb.g, lightRgb.b, 0.03, 0);
        results['IC - Light'] = adjustHsl(lightRgb.r, lightRgb.g, lightRgb.b, -0.12, 0.08);
        results['IC - Dark'] = adjustHsl(lightRgb.r, lightRgb.g, lightRgb.b, 0.15, 0);
      }

      return {
        Light: rgbToHex(results.Light.r, results.Light.g, results.Light.b),
        Dark: rgbToHex(results.Dark.r, results.Dark.g, results.Dark.b),
        'IC - Light': rgbToHex(results['IC - Light'].r, results['IC - Light'].g, results['IC - Light'].b),
        'IC - Dark': rgbToHex(results['IC - Dark'].r, results['IC - Dark'].g, results['IC - Dark'].b)
      };
    }

    function updateColorPreview() {
      const hex = hexInput.value;
      if (hex.length === 6) {
        colorPreview.style.background = '#' + hex;
        const colors = generateModeColors(hex, selectedMode);
        if (colors) {
          document.getElementById('preview-light').style.background = '#' + colors.Light;
          document.getElementById('preview-dark').style.background = '#' + colors.Dark;
          document.getElementById('preview-ic-light').style.background = '#' + colors['IC - Light'];
          document.getElementById('preview-ic-dark').style.background = '#' + colors['IC - Dark'];
        }
      } else {
        colorPreview.style.background = '#fff';
        document.getElementById('preview-light').style.background = '#ccc';
        document.getElementById('preview-dark').style.background = '#ccc';
        document.getElementById('preview-ic-light').style.background = '#ccc';
        document.getElementById('preview-ic-dark').style.background = '#ccc';
      }
    }

    // Generate Modes button
    generateModesButton.onclick = () => {
      const hex = hexInput.value;
      const varName = varNameInput.value.trim();
      const collectionId = modeCollectionSelect.value || null;

      if (hex.length !== 6) {
        showMessage(modemakerMessageDiv, 'Please enter a valid 6-digit hex code', 'error');
        return;
      }
      if (!varName) {
        showMessage(modemakerMessageDiv, 'Please enter a variable name', 'error');
        return;
      }

      const colors = generateModeColors(hex, selectedMode);
      parent.postMessage({
        pluginMessage: {
          type: 'generate-mode-colors',
          collectionId,
          varName,
          colors
        }
      }, '*');
    };

    function showMessage(element, text, type) {
      element.textContent = text;
      element.className = `message ${type}`;
      element.style.display = 'block';
      
      setTimeout(() => {
        element.style.display = 'none';
      }, 3000);
    }

    // Enable/disable generate button based on selection
    genCollectionSelect.onchange = () => {
      generateButton.disabled = !genCollectionSelect.value;
    };

    // Create Variables button
    createButton.onclick = () => {
      const collectionId = collectionSelect.value || null;
      parent.postMessage({ 
        pluginMessage: { 
          type: 'create-variables', 
          collectionId 
        } 
      }, '*');
    };

    // Generate Layers button
    const bindVariablesCheckbox = document.getElementById('bind-variables');
    
    generateButton.onclick = () => {
      const collectionId = genCollectionSelect.value;
      if (!collectionId) return;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'generate-layers', 
          collectionId,
          bindVariables: bindVariablesCheckbox.checked
        } 
      }, '*');
    };

    // Interpolate Colors button
    interpolateButton.onclick = () => {
      const collectionId = interpolateCollectionSelect.value || null;
      parent.postMessage({ 
        pluginMessage: { 
          type: 'interpolate-colors', 
          collectionId 
        } 
      }, '*');
    };

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'collections') {
        // Save current selections
        const currentValue = collectionSelect.value;
        const currentGenValue = genCollectionSelect.value;
        const currentInterpolateValue = interpolateCollectionSelect.value;
        
        // Update create tab dropdown
        collectionSelect.innerHTML = '<option value="">Create new collection</option>';
        msg.collections.forEach(collection => {
          const option = document.createElement('option');
          option.value = collection.id;
          option.textContent = collection.name;
          collectionSelect.appendChild(option);
        });
        
        // Update generate tab dropdown
        genCollectionSelect.innerHTML = '<option value="" disabled>Select a collection</option>';
        msg.collections.forEach(collection => {
          const option = document.createElement('option');
          option.value = collection.id;
          option.textContent = collection.name;
          genCollectionSelect.appendChild(option);
        });

        // Update interpolate tab dropdown
        interpolateCollectionSelect.innerHTML = '<option value="">Create new collection</option>';
        msg.collections.forEach(collection => {
          const option = document.createElement('option');
          option.value = collection.id;
          option.textContent = collection.name;
          interpolateCollectionSelect.appendChild(option);
        });

        // Update mode maker tab dropdown
        const currentModeValue = modeCollectionSelect.value;
        modeCollectionSelect.innerHTML = '<option value="">Create new collection</option>';
        msg.collections.forEach(collection => {
          const option = document.createElement('option');
          option.value = collection.id;
          option.textContent = collection.name;
          modeCollectionSelect.appendChild(option);
        });
        
        // Restore selections
        if (currentValue) collectionSelect.value = currentValue;
        if (currentGenValue) {
          genCollectionSelect.value = currentGenValue;
          generateButton.disabled = false;
        }
        if (currentInterpolateValue) interpolateCollectionSelect.value = currentInterpolateValue;
        if (currentModeValue) modeCollectionSelect.value = currentModeValue;
      }
      
      if (msg.type === 'success') {
        showMessage(createMessageDiv, msg.message, 'success');
      }
      
      if (msg.type === 'generate-success') {
        showMessage(generateMessageDiv, msg.message, 'success');
      }
      
      if (msg.type === 'error') {
        showMessage(createMessageDiv, msg.message, 'error');
      }
      
      if (msg.type === 'generate-error') {
        showMessage(generateMessageDiv, msg.message, 'error');
      }

      if (msg.type === 'interpolate-success') {
        showMessage(interpolateMessageDiv, msg.message, 'success');
      }

      if (msg.type === 'interpolate-error') {
        showMessage(interpolateMessageDiv, msg.message, 'error');
      }

      if (msg.type === 'modemaker-success') {
        showMessage(modemakerMessageDiv, msg.message, 'success');
      }

      if (msg.type === 'modemaker-error') {
        showMessage(modemakerMessageDiv, msg.message, 'error');
      }
    };
  </script>
</body>
</html>
